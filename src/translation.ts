import * as vscode from 'vscode';
import axios from 'axios';

interface TranslationResult {
    translatedText: string;
}

export class TranslationProvider {
    private async googleTranslate(text: string, targetLang: string, sourceLang: string = 'auto'): Promise<string> {
        try {
            // 使用Google翻译API的免费端点
            const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sourceLang}&tl=${targetLang}&dt=t&q=${encodeURIComponent(text)}`;

            const response = await axios.get(url);
            if (response.data && response.data[0]) {
                return response.data[0].map((item: any[]) => item[0]).join('');
            }
            return text;
        } catch (error) {
            console.error('Google翻译错误:', error);
            throw error;
        }
    }



    private localDictionary: Map<string, string> = new Map([
        ['hello', '你好'],
        ['world', '世界'],
        ['translate', '翻译'],
        ['plugin', '插件'],
        ['extension', '扩展'],
        ['vscode', 'VS Code'],
        ['code', '代码'],
        ['file', '文件'],
        ['editor', '编辑器'],
        ['command', '命令'],
        ['configuration', '配置'],
        ['setting', '设置'],
        ['function', '函数'],
        ['variable', '变量'],
        ['class', '类'],
        ['interface', '接口'],
        ['method', '方法'],
        ['property', '属性'],
        ['import', '导入'],
        ['export', '导出'],
        ['const', '常量'],
        ['let', '变量'],
        ['var', '变量'],
        ['if', '如果'],
        ['else', '否则'],
        ['for', '循环'],
        ['while', '当'],
        ['return', '返回'],
        ['true', '真'],
        ['false', '假'],
        ['null', '空值'],
        ['undefined', '未定义'],
        ['object', '对象'],
        ['array', '数组'],
        ['string', '字符串'],
        ['number', '数字'],
        ['boolean', '布尔值'],
        ['type', '类型'],
        ['interface', '接口'],
        ['generic', '泛型'],
        ['async', '异步'],
        ['await', '等待'],
        ['promise', '承诺'],
        ['callback', '回调'],
        ['error', '错误'],
        ['exception', '异常'],
        ['try', '尝试'],
        ['catch', '捕获'],
        ['finally', '最终'],
        ['throw', '抛出'],
        ['debug', '调试'],
        ['breakpoint', '断点'],
        ['log', '日志'],
        ['console', '控制台'],
        ['window', '窗口'],
        ['document', '文档'],
        ['element', '元素'],
        ['attribute', '属性'],
        ['event', '事件'],
        ['listener', '监听器'],
        ['handler', '处理器'],
        ['request', '请求'],
        ['response', '响应'],
        ['api', '接口'],
        ['rest', 'REST'],
        ['json', 'JSON'],
        ['xml', 'XML'],
        ['html', 'HTML'],
        ['css', 'CSS'],
        ['javascript', 'JavaScript'],
        ['typescript', 'TypeScript'],
        ['react', 'React'],
        ['angular', 'Angular'],
        ['vue', 'Vue'],
        ['node', 'Node.js'],
        ['express', 'Express'],
        ['database', '数据库'],
        ['server', '服务器'],
        ['client', '客户端'],
        ['frontend', '前端'],
        ['backend', '后端'],
        ['fullstack', '全栈'],
        ['development', '开发'],
        ['programming', '编程'],
        ['software', '软件'],
        ['application', '应用程序'],
        ['mobile', '移动'],
        ['web', '网页'],
        ['desktop', '桌面'],
        ['framework', '框架'],
        ['library', '库'],
        ['dependency', '依赖'],
        ['package', '包'],
        ['module', '模块'],
        ['npm', 'NPM'],
        ['yarn', 'Yarn'],
        ['git', 'Git'],
        ['repository', '仓库'],
        ['branch', '分支'],
        ['commit', '提交'],
        ['merge', '合并'],
        ['pull', '拉取'],
        ['push', '推送'],
        ['clone', '克隆'],
        ['test', '测试'],
        ['unit', '单元'],
        ['integration', '集成'],
        ['e2e', '端到端'],
        ['automation', '自动化'],
        ['ci', '持续集成'],
        ['cd', '持续部署'],
        ['deploy', '部署'],
        ['build', '构建'],
        ['compile', '编译'],
        ['bundle', '打包'],
        ['minify', '压缩'],
        ['optimize', '优化'],
        ['performance', '性能'],
        ['speed', '速度'],
        ['memory', '内存'],
        ['cpu', 'CPU'],
        ['cache', '缓存'],
        ['storage', '存储'],
        ['security', '安全'],
        ['authentication', '认证'],
        ['authorization', '授权'],
        ['encryption', '加密'],
        ['hash', '哈希'],
        ['password', '密码'],
        ['username', '用户名'],
        ['login', '登录'],
        ['logout', '登出'],
        ['session', '会话'],
        ['cookie', 'Cookie'],
        ['token', '令牌'],
        ['jwt', 'JWT'],
        ['oauth', 'OAuth'],
        ['api', 'API'],
        ['endpoint', '端点'],
        ['route', '路由'],
        ['middleware', '中间件'],
        ['controller', '控制器'],
        ['service', '服务'],
        ['model', '模型'],
        ['view', '视图'],
        ['template', '模板'],
        ['render', '渲染'],
        ['layout', '布局'],
        ['component', '组件'],
        ['props', '属性'],
        ['state', '状态'],
        ['hook', '钩子'],
        ['effect', '副作用'],
        ['reducer', '化简器'],
        ['dispatch', '派发'],
        ['action', '动作'],
        ['store', '存储'],
        ['provider', '提供者'],
        ['consumer', '消费者'],
        ['context', '上下文'],
        ['theme', '主题'],
        ['style', '样式'],
        ['layout', '布局'],
        ['responsive', '响应式'],
        ['mobile', '移动端'],
        ['tablet', '平板'],
        ['desktop', '桌面端'],
        ['browser', '浏览器'],
        ['chrome', 'Chrome'],
        ['firefox', 'Firefox'],
        ['safari', 'Safari'],
        ['edge', 'Edge'],
        ['internet', 'Internet Explorer'],
        ['engine', '引擎'],
        ['webkit', 'Webkit'],
        ['blink', 'Blink'],
        ['v8', 'V8'],
        ['javascript', 'JavaScript引擎'],
        ['runtime', '运行时'],
        ['engine', '引擎'],
        ['virtual', '虚拟'],
        ['machine', '机器'],
        ['runtime', '运行时'],
        ['environment', '环境'],
        ['platform', '平台'],
        ['operating', '操作系统'],
        ['system', '系统'],
        ['linux', 'Linux'],
        ['windows', 'Windows'],
        ['macos', 'macOS'],
        ['unix', 'Unix'],
        ['android', 'Android'],
        ['ios', 'iOS'],
        ['iphone', 'iPhone'],
        ['ipad', 'iPad'],
        ['apple', '苹果'],
        ['google', '谷歌'],
        ['microsoft', '微软'],
        ['amazon', '亚马逊'],
        ['facebook', 'Facebook'],
        ['meta', 'Meta'],
        ['twitter', 'Twitter'],
        ['linkedin', 'LinkedIn'],
        ['github', 'GitHub'],
        ['gitlab', 'GitLab'],
        ['bitbucket', 'Bitbucket'],
        ['docker', 'Docker'],
        ['kubernetes', 'Kubernetes'],
        ['container', '容器'],
        ['image', '镜像'],
        ['pod', 'Pod'],
        ['cluster', '集群'],
        ['deployment', '部署'],
        ['service', '服务'],
        ['ingress', '入口'],
        ['load', '负载均衡'],
        ['balancer', '平衡器'],
        ['proxy', '代理'],
        ['reverse', '反向代理'],
        ['forward', '正向代理'],
        ['firewall', '防火墙'],
        ['router', '路由器'],
        ['switch', '交换机'],
        ['hub', '集线器'],
        ['port', '端口'],
        ['protocol', '协议'],
        ['tcp', 'TCP'],
        ['udp', 'UDP'],
        ['http', 'HTTP'],
        ['https', 'HTTPS'],
        ['ftp', 'FTP'],
        ['ssh', 'SSH'],
        ['ssl', 'SSL'],
        ['tls', 'TLS'],
        ['certificate', '证书'],
        ['domain', '域名'],
        ['host', '主机'],
        ['hostname', '主机名'],
        ['ip', 'IP地址'],
        ['address', '地址'],
        ['network', '网络'],
        ['subnet', '子网'],
        ['gateway', '网关'],
        ['dns', 'DNS'],
        ['dhcp', 'DHCP'],
        ['nat', 'NAT'],
        ['vpn', 'VPN'],
        ['tunnel', '隧道'],
        ['connection', '连接'],
        ['socket', '套接字'],
        ['stream', '流'],
        ['buffer', '缓冲区'],
        ['pipe', '管道'],
        ['channel', '通道'],
        ['thread', '线程'],
        ['process', '进程'],
        ['multithreading', '多线程'],
        ['multiprocessing', '多进程'],
        ['concurrent', '并发'],
        ['parallel', '并行'],
        ['asynchronous', '异步'],
        ['synchronous', '同步'],
        ['blocking', '阻塞'],
        ['non-blocking', '非阻塞'],
        ['queue', '队列'],
        ['stack', '栈'],
        ['heap', '堆'],
        ['linked', '链表'],
        ['list', '列表'],
        ['tree', '树'],
        ['graph', '图'],
        ['algorithm', '算法'],
        ['data', '数据结构'],
        ['structure', '结构'],
        ['complexity', '复杂度'],
        ['time', '时间复杂度'],
        ['space', '空间复杂度'],
        ['sort', '排序'],
        ['search', '搜索'],
        ['linear', '线性查找'],
        ['binary', '二分查找'],
        ['bubble', '冒泡排序'],
        ['quick', '快速排序'],
        ['merge', '归并排序'],
        ['insertion', '插入排序'],
        ['selection', '选择排序'],
        ['heap', '堆排序'],
        ['shell', '希尔排序'],
        ['radix', '基数排序'],
        ['counting', '计数排序'],
        ['bucket', '桶排序'],
        ['hash', '哈希表'],
        ['map', '映射'],
        ['set', '集合'],
        ['array', '数组'],
        ['matrix', '矩阵'],
        ['vector', '向量'],
        ['pointer', '指针'],
        ['reference', '引用'],
        ['dereference', '解引用'],
        ['memory', '内存管理'],
        ['allocation', '分配'],
        ['deallocation', '释放'],
        ['garbage', '垃圾回收'],
        ['collection', '收集'],
        ['leak', '泄漏'],
        ['fragmentation', '碎片'],
        ['compaction', '紧缩'],
        ['paging', '分页'],
        ['segmentation', '分段'],
        ['virtual', '虚拟内存'],
        ['cache', '高速缓存'],
        ['l1', 'L1缓存'],
        ['l2', 'L2缓存'],
        ['l3', 'L3缓存'],
        ['ram', '随机存取存储器'],
        ['rom', '只读存储器'],
        ['ssd', '固态硬盘'],
        ['hdd', '机械硬盘'],
        ['disk', '磁盘'],
        ['partition', '分区'],
        ['filesystem', '文件系统'],
        ['ntfs', 'NTFS'],
        ['ext4', 'EXT4'],
        ['fat32', 'FAT32'],
        ['exfat', 'exFAT'],
        ['btrfs', 'Btrfs'],
        ['zfs', 'ZFS'],
        ['file', '文件'],
        ['directory', '目录'],
        ['folder', '文件夹'],
        ['path', '路径'],
        ['absolute', '绝对路径'],
        ['relative', '相对路径'],
        ['root', '根目录'],
        ['home', '家目录'],
        ['current', '当前目录'],
        ['parent', '父目录'],
        ['child', '子目录'],
        ['symlink', '符号链接'],
        ['hardlink', '硬链接'],
        ['permissions', '权限'],
        ['chmod', '修改权限'],
        ['chown', '修改所有者'],
        ['chgrp', '修改组'],
        ['read', '读取'],
        ['write', '写入'],
        ['execute', '执行'],
        ['owner', '所有者'],
        ['group', '组'],
        ['others', '其他'],
        ['rwx', '读写执行权限'],
        ['numeric', '数字权限'],
        ['symbolic', '符号权限'],
        ['umask', '默认权限掩码'],
        ['process', '进程管理'],
        ['ps', '查看进程'],
        ['kill', '终止进程'],
        ['pid', '进程ID'],
        ['ppid', '父进程ID'],
        ['foreground', '前台'],
        ['background', '后台'],
        ['job', '作业'],
        ['signal', '信号'],
        ['exit', '退出'],
        ['status', '状态'],
        ['running', '运行中'],
        ['sleeping', '睡眠中'],
        ['stopped', '已停止'],
        ['zombie', '僵尸进程'],
        ['orphan', '孤儿进程'],
        ['daemon', '守护进程'],
        ['init', '初始化进程'],
        ['systemd', '系统管理守护进程'],
        ['service', '服务'],
        ['unit', '单元'],
        ['target', '目标'],
        ['timer', '定时器'],
        ['socket', '套接字单元'],
        ['device', '设备单元'],
        ['mount', '挂载单元'],
        ['automount', '自动挂载'],
        ['swap', '交换空间'],
        ['swappiness', '交换倾向'],
        ['oom', '内存不足'],
        ['killer', '杀手'],
        ['priority', '优先级'],
        ['nice', '友好值'],
        ['renice', '重新设置友好值'],
        ['ionice', 'IO优先级'],
        ['realtime', '实时'],
        ['scheduling', '调度'],
        ['scheduler', '调度器'],
        ['policy', '策略'],
        ['round', '轮转'],
        ['robin', '轮询'],
        ['fifo', '先进先出'],
        ['rr', '轮转调度'],
        ['deadline', '截止时间'],
        ['cfq', '完全公平队列'],
        ['bfq', '最佳可用队列'],
        ['noop', '无操作'],
        ['anticipation', '预期'],
        ['deadline', '截止时间'],
        ['as', '前瞻'],
        ['mq', '多队列'],
        ['dequeue', '出队'],
        ['enqueue', '入队'],
        ['head', '头部'],
        ['tail', '尾部'],
        ['front', '前部'],
        ['back', '后部'],
        ['size', '大小'],
        ['capacity', '容量'],
        ['empty', '空'],
        ['full', '满'],
        ['clear', '清空'],
        ['reserve', '预留'],
        ['shrink', '收缩'],
        ['expand', '扩展'],
        ['resize', '重置大小'],
        ['iterator', '迭代器'],
        ['range', '范围'],
        ['begin', '开始'],
        ['end', '结束'],
        ['cbegin', '常量开始'],
        ['cend', '常量结束'],
        ['rbegin', '逆向开始'],
        ['rend', '逆向结束'],
        ['crbegin', '常量逆向开始'],
        ['crend', '常量逆向结束'],
        ['advance', '前进'],
        ['distance', '距离'],
        ['next', '下一个'],
        ['prev', '上一个'],
        ['insert', '插入'],
        ['erase', '擦除'],
        ['emplace', '原位构造'],
        ['emplace_back', '尾部原位构造'],
        ['push_back', '尾部压入'],
        ['pop_back', '尾部弹出'],
        ['push_front', '头部压入'],
        ['pop_front', '头部弹出'],
        ['assign', '赋值'],
        ['swap', '交换'],
        ['merge', '合并'],
        ['splice', '拼接'],
        ['unique', '去重'],
        ['remove', '移除'],
        ['reverse', '反转'],
        ['rotate', '旋转'],
        ['shuffle', '洗牌'],
        ['sort', '排序'],
        ['stable_sort', '稳定排序'],
        ['partial_sort', '部分排序'],
        ['nth_element', '第N个元素'],
        ['lower_bound', '下界'],
        ['upper_bound', '上界'],
        ['equal_range', '相等范围'],
        ['binary_search', '二分搜索'],
        ['find', '查找'],
        ['find_if', '条件查找'],
        ['find_if_not', '条件否定查找'],
        ['find_first_of', '首次出现'],
        ['adjacent_find', '相邻查找'],
        ['count', '计数'],
        ['count_if', '条件计数'],
        ['mismatch', '不匹配'],
        ['equal', '相等'],
        ['is_permutation', '排列'],
        ['search', '搜索'],
        ['search_n', '搜索N个'],
        ['copy', '复制'],
        ['copy_if', '条件复制'],
        ['copy_n', '复制N个'],
        ['copy_backward', '向后复制'],
        ['move', '移动'],
        ['move_backward', '向后移动'],
        ['fill', '填充'],
        ['fill_n', '填充N个'],
        ['transform', '变换'],
        ['generate', '生成'],
        ['generate_n', '生成N个'],
        ['remove_copy', '移除复制'],
        ['remove_copy_if', '条件移除复制'],
        ['replace', '替换'],
        ['replace_if', '条件替换'],
        ['replace_copy', '替换复制'],
        ['replace_copy_if', '条件替换复制'],
        ['swap_ranges', '交换范围'],
        ['iter_swap', '迭代器交换'],
        ['reverse_copy', '反转复制'],
        ['rotate_copy', '旋转复制'],
        ['random_shuffle', '随机洗牌'],
        ['unique_copy', '去重复制'],
        ['partition', '分割'],
        ['stable_partition', '稳定分割'],
        ['partition_copy', '分割复制'],
        ['partition_point', '分割点'],
        ['is_partitioned', '已分割'],
        ['is_sorted', '已排序'],
        ['is_sorted_until', '直到排序'],
        ['is_heap', '是堆'],
        ['is_heap_until', '直到堆'],
        ['min_element', '最小元素'],
        ['max_element', '最大元素'],
        ['minmax_element', '最值元素'],
        ['lexicographical_compare', '字典比较'],
        ['is_permutation', '是排列'],
        ['next_permutation', '下一个排列'],
        ['prev_permutation', '上一个排列'],
        ['is_sorted', '已排序'],
        ['is_sorted_until', '直到排序'],
        ['is_binary_heap', '是二进制堆'],
        ['make_heap', '创建堆'],
        ['push_heap', '压入堆'],
        ['pop_heap', '弹出堆'],
        ['sort_heap', '堆排序'],
        ['includes', '包含'],
        ['set_union', '集合并'],
        ['set_intersection', '集合交'],
        ['set_difference', '集合并差'],
        ['set_symmetric_difference', '集合对称差'],
        ['merge', '合并'],
        ['inplace_merge', '就地合并'],
        ['push', '压入'],
        ['pop', '弹出'],
        ['top', '顶部'],
        ['empty', '空'],
        ['size', '大小'],
        ['front', '前部'],
        ['back', '后部'],
        ['emplace', '原位构造'],
        ['emplace_front', '头部原位构造'],
        ['emplace_back', '尾部原位构造'],
        ['at', '访问'],
        ['operator[]', '下标操作'],
        ['data', '数据'],
        ['c_str', 'C字符串'],
        ['length', '长度'],
        ['size', '大小'],
        ['max_size', '最大大小'],
        ['resize', '重置大小'],
        ['capacity', '容量'],
        ['reserve', '预留'],
        ['shrink_to_fit', '收缩到适合'],
        ['clear', '清空'],
        ['insert', '插入'],
        ['erase', '擦除'],
        ['push_back', '尾部压入'],
        ['pop_back', '尾部弹出'],
        ['append', '追加'],
        ['operator+=', '复合赋值'],
        ['compare', '比较'],
        ['substr', '子串'],
        ['copy', '复制'],
        ['find', '查找'],
        ['rfind', '反向查找'],
        ['find_first_of', '首次出现'],
        ['find_last_of', '最后出现'],
        ['find_first_not_of', '首次不出现'],
        ['find_last_not_of', '最后不出现'],
        ['replace', '替换'],
        ['swap', '交换'],
        ['getline', '获取行'],
        ['stoi', '字符串到整数'],
        ['stol', '字符串到长整数'],
        ['stoll', '字符串到长长整数'],
        ['stoul', '字符串到无符号长整数'],
        ['stoull', '字符串到无符号长长整数'],
        ['stof', '字符串到浮点数'],
        ['stod', '字符串到双精度'],
        ['stold', '字符串到长双精度'],
        ['to_string', '转换到字符串'],
        ['to_wstring', '转换到宽字符串']
    ]);

    private async localTranslate(text: string): Promise<string> {
        // 尝试在本地词典中查找精确匹配
        const lowerText = text.toLowerCase();
        if (this.localDictionary.has(lowerText)) {
            return this.localDictionary.get(lowerText)!;
        }

        // 尝试查找部分匹配（对于短语）
        const words = text.split(/\s+/);
        if (words.length === 1) {
            return this.localDictionary.get(lowerText) || text;
        } else {
            // 对于多个单词，逐个翻译
            const translatedWords = [];
            for (const word of words) {
                const cleanWord = word.replace(/[^\w\s']|_/g, "").replace(/\s+/g, " ");
                const translatedWord = this.localDictionary.get(cleanWord.toLowerCase()) || word;
                translatedWords.push(translatedWord);
            }
            return translatedWords.join(' ');
        }
    }

    public async translate(text: string): Promise<string> {
        const config = vscode.workspace.getConfiguration('vs-dao-translate');
        const service: string = config.get('translationService', 'google') as string;
        const targetLang = config.get('targetLanguage', 'zh-CN');
        const sourceLang = config.get('sourceLanguage', 'auto');

        // 如果文本太短，直接返回
        if (!text || text.trim().length === 0) {
            return '';
        }

        try {
            switch (service) {
                case 'google':
                    return await this.googleTranslate(text, targetLang, sourceLang);
                case 'local':
                    return await this.localTranslate(text);
                default:
                    return await this.googleTranslate(text, targetLang, sourceLang);
            }
        } catch (error) {
            console.error(`翻译服务 ${service} 失败:`, error);
            // 如果主要服务失败，尝试本地词典
            try {
                return await this.localTranslate(text);
            } catch (localError) {
                console.error('本地翻译也失败:', localError);
                return text; // 返回原文本作为备选方案
            }
        }
    }
}